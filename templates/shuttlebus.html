<!DOCTYPE html>
<html>
	<head>
		<!-- Ajax  -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<!-- End Ajax  -->

		<!-- Bootstrap  -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		<!-- End Bootstrap  -->

		<!-- Google Map  -->
		<!--script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBeId-aJWa_EA6FwqCbDJOjjLL6Qe1gr9E&sensor=false"></script-->
		<script src="https://maps.googleapis.com/maps/api/js?libraries=weather&sensor=true"></script>
		<!-- End Google Map  -->

		<script>						
			
			var mapref = null;
			var glob = null;

			var bus_maker_map = {};

			function addStopMarker(latlng, title, map){
				var marker = new google.maps.Marker(
									{
						  				position: new google.maps.LatLng(latlng[0], latlng[1]),
						  				map: map,
						  				title: title,						  				
						  				icon: {path: google.maps.SymbolPath.CIRCLE,scale: 5},
						  			}
	  						);

				var infowindow = new google.maps.InfoWindow({
				  	content: "",	  				  
				  });

				google.maps.event.addListener(marker, 'click', function() {
    				infowindow.open(map,marker);
  				});
			}

			function addBusMarker(bus, snapshot, title, map){

				var marker = new google.maps.Marker(
									{
						  				position: new google.maps.LatLng(bus['lonlat'][0], bus['lonlat'][1]),
						  				map: map,
						  				title: title,
						  				//animation: google.maps.Animation.BOUNCE // DROP
						  				//icon: {url:'yo.jpg', size: new google.maps.Size(5, 5)},
						  				//icon: {path: google.maps.SymbolPath.CIRCLE,scale: 5},
						  			}
	  						);
				bus_maker_map['busid'] = marker;
				var contentString = "<img src=" + snapshot + " width='100' height='100'/>";

				var infowindow = new google.maps.InfoWindow({
				  	content: contentString,	  				  
				  });

				google.maps.event.addListener(marker, 'click', function() {
    				infowindow.open(map,marker);
  				});

			}

			function initWeather(map){
				var weatherLayer = new google.maps.weather.WeatherLayer({
							    temperatureUnits: google.maps.weather.TemperatureUnit.CELSIUS
							  });
				weatherLayer.setMap(map);
				/*
				google.maps.event.addListener(weatherLayer, 'click', function(e) {
  						alert('The current temperature at ' + e.featureDetails.location + ' is '
        				+ e.featureDetails.current.temperature + ' degrees.');
				});
				*/
			  	//var cloudLayer = new google.maps.weather.CloudLayer();
			  	//cloudLayer.setMap(map);
			}

			function mapStyleBuilder(){
				var stylesArray = [
			    {
			        "featureType": "landscape",
			        "stylers": [
			            {
			                "visibility": "simplified"
			            },
			            {
			                "color": "#000000"
			            },
			            {
			                "weight": 0.1
			            }
			        ]
			    },
			    {
			        "featureType": "administrative",
			        "stylers": [
			            {
			                "visibility": "on"
			            },
			            {
			                "hue": "#ff0000"
			            },
			            {
			                "weight": 0.4
			            },
			            {
			                "color": "#ffffff"
			            }
			        ]
			    },
			    {
			        "featureType": "road.highway",
			        "elementType": "labels.text",
			        "stylers": [
			            {
			                "weight": 1.3
			            },
			            {
			                "color": "#FFFFFF"
			            }
			        ]
			    },
			    {
			        "featureType": "road.highway",
			        "elementType": "geometry",
			        "stylers": [
			            {
			                "color": "#B52127"
			            },
			            {
			                "weight": 3
			            }
			        ]
			    },
			    {
			        "featureType": "road.arterial",
			        "elementType": "geometry",
			        "stylers": [
			            {
			                "color": "#B52127"
			            },
			            {
			                "weight": 1.1
			            }
			        ]
			    },
			    {
			        "featureType": "road.local",
			        "elementType": "geometry",
			        "stylers": [
			            {
			                "color": "#B52127"
			            },
			            {
			                "weight": 0.4
			            }
			        ]
			    },
			    {},
			    {
			        "featureType": "road.highway",
			        "elementType": "labels",
			        "stylers": [
			            {
			                "weight": 0.8
			            },
			            {
			                "color": "#ffffff"
			            },
			            {
			                "visibility": "on"
			            }
			        ]
			    },
			    {
			        "featureType": "road.local",
			        "elementType": "labels",
			        "stylers": [
			            {
			                "visibility": "off"
			            }
			        ]
			    },
			    {
			        "featureType": "road.arterial",
			        "elementType": "labels",
			        "stylers": [
			            {
			                "color": "#ffffff"
			            },
			            {
			                "weight": 0.7
			            }
			        ]
			    },
			    {
			        "featureType": "poi",
			        "elementType": "labels",
			        "stylers": [
			            {
			                "visibility": "off"
			            }
			        ]
			    },
			    {
			        "featureType": "poi",
			        "stylers": [
			            {
			                "color": "#E6AB16"
			            }
			        ]
			    },
			    {
			        "featureType": "water",
			        "stylers": [
			            {
			                "color": "#00a9ca"
			            }
			        ]
			    },
			    {
			        "featureType": "transit.line",
			        "stylers": [
			            {
			                "visibility": "on"
			            }
			        ]
			    }
			]

			  	return stylesArray;
			}

			function addTraffic(map){
				
				var trafficLayer = new google.maps.TrafficLayer();
  				trafficLayer.setMap(map);				
			}

			function addBusPanel(bus, map){
				html_el = '<div onclick=""><div class="panel panel-success"> \
				  <div class="panel-heading">'
				  + 'Bus id: ' +  bus['bus_id'] + '</div> \
				  <div class="panel-body"> \
			    ' + bus['bus_id'] + ' ' + bus['lonlat']+
				'</div> \
				</div></div> ';

				$("#buses-side-menu").append(html_el);
				//infowindow.open(map,bus_maker_map[bus["bus_id"]]);

			}
			
			function initBuses(map){

				var request = $.ajax({
									  url: "BusesGeo",
									  type: "GET",									 
									});									 
				request.done(function( msg ) {				  
				  buses_json = JSON.parse(msg);
				  for(bus_index in buses_json){
				  	bus = buses_json[bus_index];
				  	addBusMarker(bus, "yo.jpg", "NONE", map );
				  	addBusPanel(bus, map);
				  }
				  console.log( msg );
				});
				 
				request.fail(function( jqXHR, textStatus ) {
				  alert( "Request failed: " + textStatus );
					});
			}

			function initStops(map){

				var request = $.ajax({
									  url: "StopsGeo",
									  type: "GET",									 
									});									 
				request.done(function( msg ) {				  
				  stops_json = JSON.parse(msg);
				  for(stop_index in stops_json){
				  	stop = stops_json[stop_index];
				  	addStopMarker( stop['lonlat'], stop['name'], map );				  	
				  }
				  console.log( msg );
				});
				 
				request.fail(function( jqXHR, textStatus ) {
				  alert( "Request failed: " + textStatus );
					});
			}

			function initialize()
			{
				stylearray = [
				    {
				        "stylers": [
				            {
				                "hue": "#007fff"
				            },
				            {
				                "saturation": 89
				            }
				        ]
				    },				    
				    {
				        "featureType": "administrative.country",
				        "elementType": "labels",
				        "stylers": [
				            {
				                "visibility": "off"
				            }
				        ]
				    }
				]
				
				var mapOptions = {
					center: new google.maps.LatLng(43.6170021,-79.506403),				  
				  	zoom: 11,
				  	mapTypeId:google.maps.MapTypeId.ROADMAP,
				  	disableDefaultUI: true,	
				  	styles: stylearray,
				  	
				  };


				var map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);

				map.setOptions({style: mapStyleBuilder()})
							
				
				initBuses(map);
				initStops(map);

				initWeather(map);				
				//mapref = map;
			}
			
			google.maps.event.addDomListener(window, 'load', initialize);

		</script>

		<script>

			function ajaxTest(){

				var request = $.ajax({
									  url: "usercount",
									  type: "POST",
									  data: { 'id' : '12345' },
									  dataType: "html"
									});
									 
				request.done(function( msg ) {
				  //$( "#log" ).html( msg );
				  console.log( msg );
				});
				 
				request.fail(function( jqXHR, textStatus ) {
				  alert( "Request failed: " + textStatus );
					});

			}
		</script>
	</head>

	<body>
		<div class="content-main">

			<div id="map-canvas" class="col-sm-12 col-md-12 col-lg-10" style="width:1000px;height:800px;"></div>

			<div id='buses-side-menu' class="col-sm-12 col-md-12 col-lg-2">
				
			</div>

		</div>
		
	</body>
</html>